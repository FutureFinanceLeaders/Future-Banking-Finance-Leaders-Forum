<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Upgrade to Premium | FFL</title>

<style>
body{
  margin:0;
  font-family:Arial, Helvetica, sans-serif;
  background:#0f172a;
  color:white;
}

.container{
  max-width:800px;
  margin:auto;
  padding:40px 20px;
}

.card{
  background:#1e293b;
  padding:30px;
  border-radius:12px;
  box-shadow:0 10px 30px rgba(0,0,0,0.4);
}

h1{
  text-align:center;
  margin-bottom:10px;
}

.price{
  text-align:center;
  font-size:28px;
  font-weight:bold;
  color:#22c55e;
  margin-bottom:20px;
}

.features{
  margin-bottom:30px;
}

.features li{
  margin-bottom:10px;
}

button{
  width:100%;
  padding:15px;
  border:none;
  border-radius:8px;
  font-size:16px;
  font-weight:bold;
  cursor:pointer;
  transition:0.3s;
}

.primary{
  background:#22c55e;
  color:white;
}

.primary:hover{
  background:#16a34a;
}

.secondary{
  margin-top:10px;
  background:#334155;
  color:white;
}

.secondary:hover{
  background:#475569;
}

.message{
  margin-top:15px;
  padding:10px;
  border-radius:6px;
  display:none;
}

.success{
  background:#166534;
}

.error{
  background:#7f1d1d;
}
</style>
</head>
<body>

<div class="container">
  <div class="card">
    <h1>Upgrade to Premium</h1>
    <div class="price">$19 / Month</div>

    <ul class="features">
      <li>âœ” Access to Premium Courses</li>
      <li>âœ” Exclusive Webinars & Events</li>
      <li>âœ” Mentor Messaging</li>
      <li>âœ” Downloadable Resources</li>
      <li>âœ” Premium Community Access</li>
    </ul>

    <button id="mtnPayBtn" class="primary">
      Pay with MTN Mobile Money
    </button>

    <button onclick="window.location.href='dashboard.html'" class="secondary">
      Cancel
    </button>

    <div id="message" class="message"></div>
  </div>
</div>

<!-- MTN Widget -->
<script src="https://momodeveloper.mtn.com/widget/v1/momo-widget.js"></script>

<script type="module">

import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
import { getDatabase, ref, set } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js";

const firebaseConfig = {
  apiKey: "AIzaSyD-CihaWuOxgcGc02lY3jDdD8K-F6Fux2k",
  authDomain: "future-finance-leaders.firebaseapp.com",
  databaseURL: "https://future-finance-leaders-default-rtdb.europe-west1.firebasedatabase.app",
  projectId: "future-finance-leaders",
  storageBucket: "future-finance-leaders.firebasestorage.app",
  messagingSenderId: "388995690205",
  appId: "1:388995690205:web:296474a99df73907c77534"
};

const app = initializeApp(firebaseConfig);
const auth = getAuth(app);
const db = getDatabase(app);

let currentUser = null;

const messageDiv = document.getElementById("message");

function showMessage(text, type){
  messageDiv.innerText = text;
  messageDiv.className = "message " + type;
  messageDiv.style.display = "block";
}

onAuthStateChanged(auth, (user)=>{
  if(user){
    currentUser = user;
  }else{
    window.location.href = "login.html";
  }
});

document.getElementById("mtnPayBtn").addEventListener("click", ()=>{

  if(!currentUser){
    showMessage("User not authenticated", "error");
    return;
  }

  const momoWidget = new MomoWidget({
    apiKey: "f1f8cdd0f4814dd6b4dac2449b518407",  // ðŸ”¥ REPLACE THIS
    amount: "19",
    currency: "EUR",
    description: "FFL Premium Membership",
    externalId: "membership-" + Date.now(),
    payerMessage: "FFL Premium Upgrade",
    payeeNote: "Premium Access",

    onSuccess: async function (response) {

      try{

        await set(ref(db, "users/" + currentUser.uid + "/membership"), {
          level: "Premium",
          status: "active",
          upgradedAt: Date.now(),
          paymentMethod: "MTN",
          amount: 19,
          currency: "EUR",
          transactionId: response?.transactionId || null
        });

        showMessage("âœ“ Payment successful! Redirecting...", "success");

        setTimeout(()=>{
          window.location.href = "dashboard.html";
        },2000);

      }catch(error){
        showMessage("Database update failed: " + error.message, "error");
      }
    },

    onError: function (error) {
      showMessage("Payment failed. Please try again.", "error");
    }

  });

  momoWidget.open();
});

</script>
</body>
</html>